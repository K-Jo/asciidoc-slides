= Neo4j for Java Developers
:presenter: Neo Technology
:twitter: neo4j
:email: info@neotechnology.com
:backend: deckjs
:deckjsdir: ../../../asciidoc/deck.js
:deckjs_theme: neotech
:icons: font
:source-highlighter: codemirror
:navigation:
:goto:
:menu:
:status:
:arrows:
:customjs: ../../../asciidoc/js/checkcypher.js
:gist-source: https://raw.github.com/neo4j-contrib/gists/master/
:footer: © All Rights Reserved 2013 | Neo Technology, Inc.
:img: img
:logo: {img}/Neo_Technology.jpg
:allow-uri-read:
:video:
:docs-link: https://github.com/neo4j-contrib/asciidoc-slides[documentation]
:download-link: https://github.com/neo4j-contrib/asciidoc-slides/archive/master.zip[download]
:sectids!:
:deckjs_transition: none

++++
<style type="text/css">
.small {
   font-size:0.6em;
}
.big {
   font-size:1.2em;
}
</style>
++++


== Who the hell is this guy?

* Michael Hunger
* Developer Advocate Neo Technology
* Love People and Graphs
* @mesirii | michael@neotechnology.com









== What will he talk about?

[options="step"]
* Quick history of Neo4j 
* How you used Neo4j from Java
* What changed with Cypher
* How to access Neo4j Server from Java

== Question for you!

[options="step"]
* Have you used NoSQL DB's?
* Have you used Graph Databases?
* Have you used Neo4j?
* Have you used Neo4j from Java?

== A quick history of Neo4j

[options="step"]
* A small company in Sweden
* Bang
* 0.x ... small embeddable persistent graph library
* 1.x ... adding indexes, server, first stab of Cypher
* 2.x ... ease of use, data-model, optional schema, Browser

== The old days

[options="step"]
* Add neo4j-kernel (+ indexes) to dependencies
* Use the Java APIs
* Write tedious Java "POJOs" 
* Write your own wrappers

== Dependencies

[source,xml,role=big]
----
<dependency>
  <groupId>org.neo4j</groupId>
  <artifactId>neo4j-kernel</artifactId>
  <version>1.0</version>
</dependency>
----

== Java API

[source,java,role=big]
----
GraphDatabaseService db = new EmbeddedGraphDatabase(PATH);
Node emil = db.createNode();
emil.setProperty("name","Emil");
Node johan = db.createNode();
johan.setProperty("name","Johan");

Relationship rel = 
  email.createRelationshipTo(johan, DynamicRelationshipType.withName("CO_FOUNDER"));
rel.setProperty("state","mental");
db.shutdown();
----

=== That's not enough

== Java API (Transactional)

[source,java,role=big]
----

   GraphDatabaseService db = new EmbeddedGraphDatabase(PATH);
   Transaction tx = db.beginTx();
   try {
     Node emil = db.createNode();
     emil.setProperty("name","Emil");
     Node johan = db.createNode();
     johan.setProperty("name","Johan");

     Relationship rel = 
       email.createRelationshipTo(johan, DynamicRelationshipType.withName("CO_FOUNDER"));
     rel.setProperty("state","mental");
     tx.success(); 
   } finally {
     tx.finish(); 
   }
   db.shutdown();
----

=== Still not crazy enough? Watch this!

== POJOs the hard way

[source,java,role=big]
----
public class Person {

   private final Node node;
   public Person(Node node) {
     this.node = node;
   }
   
   public String getName() {
     return (String)node.getProperty("name");
   }

   public void setName(String name) {
     node.setProperty("name",name);
   }
   public Collection<Person> getFriends() {
       Collection<Person> friends = new ArrayList<Person>();
       for (Relationship r : node.getRelationships(FRIENDS)) {
          friends.add(new Person(r.getOtherNode(node)));
       }
       return friends;
   }
}
----

=== Enough Boilerplate?

== Wrappers all the way

[options=step]
* Tinkerpop + Gremlin
* jo4neo
* neo4j.rb (JRuby)
* Spring Data Neo4j

== Indexing (now Legacy)

[source,java,role=big]
----
  Index<Node> people = db.index().forNodes("People");
  people.add(node, "name","Emil");
  IndexHits<Node> result = people.get("name","Emil");

  // Lucene leaks through
  IndexHits<Node> result = people.get("name:E*");
----

== Neo4j Server

[options=step]
* embed database in jetty
* add startup scripts
* expose REST API for Nodes, Relationships, Traversals and Graph-Algos
* Plugin- and Extension Mechanisms

== Add a Web-UI

[options=step]
  * Visualization
  * Console / Shell
  * Monitoring / Stats

== Neo4j Server Strengths

[options=step]
* easier to use
* nice Web-UI (for back then)
* good for exploration and demonstration
* packaged experience

== Great for people
[options=step]
* that want to install / deploy a server
* that don't use Java / JVM
* curl+json is good enough
* proliferation of non-JVM drivers (Ruby, Python, .Net, PHP, Perl)

== Neo4j Server Weaknesses

[options=step]
* database primitives too fine-grained over the wire
* explorative REST too verbose
* no streaming (in the beginning - memory hog)
* Java-REST-Binding is a leaky abstraction
* GraphDatabaseService API over the REST API
* chatty and slow (latency)
* mirroring an embedded API was never a good idea

== Cypher for the Rescue

[options=step]
* (people)-[:HATE|LOVE]->(SQL)
* (people)-[:KNOW|USE]->(SQL)
* some good ideas

== Cypher: Good ideas

[options=step]
* Graph Patterns are easy for the brain
* Readability
* Declarative
* Idempotent
* Easier to integrate
* Complex tasks in a single operation **inside** the database

== Cypher: Refresher

=== CREATE

[source,cypher]
----
CREATE (y:Year {year: 2014})
FOREACH (m in range(1,12) |
   MERGE (y)-[:HAS_MONTH]->(:Month {month:m})
)
----

=== MATCH

[source,cypher]
----
MATCH (y:Year {year: 2014})-[:HAS_MONTH]->(m)-[:HAS_DAY]->(d),
      (y)-[:HAS_WEEK]->(w)-[:HAS_DAY]->(d)
WHERE m.month = 2
RETURN w.week,collect(d)
ORDER BY w.week ASC
LIMIT 2
----

== Cypher APIs

=== Embedded

[source,java]
----
// keep one reference
ExecutionEngine cypher = new ExecutionEngine(gdb);
String QUERY = "MATCH (u:User)-[FRIEND*2]-(friend2) WHERE u.name = {name} RETURN DISTINCT friend2.name";

ExecutionResult result = cypher.execute(QUERY, map("name","Andrés"))

for (Map<String,Object> row : result) {
   String friend2 = row.get("friend2.name")
}
----

=== Server

[source]
----
:POST /db/data/transaction[/commit] { statements: [
 {statement: "MATCH (u:User)-[FRIEND*2]-(friend2) WHERE u.name = {name} RETURN DISTINCT friend2.name",
  parameters: {name:"Andrés"}}
 , ... 
]}
----

== Cypher Drivers (JVM)

[options=step]
* Java - JDBC Driver (Java-Rest-Binding)
* Scala - AnormCypher
* Clojure - neocons
* (J)Ruby - neo4j.rb

=== Larger List


* http://neo4j.org/drivers

== Cypher Drivers (Non-JVM)

[options=step]
* Ruby - neography
* Python - py2neo, neo4j-rest-client
* Ruby - neo4j.rb, neography
* .Net - Neo4jClient
* PHP - Neo4jPHP
* Perl - REST::Neo4p

== Example: JDBC Driver

[source,java]
----
Connection conn = driver.connect("jdbc:neo4j://localhost:7474", props);

PreparedStatement ps = conn.prepareStatement("
  MATCH user-[:KNOWS]->(friend) WHERE user.name = {1} RETURN friend.name as friends");

ps.setLong(1,”Peter”);

ResultSet rs = ps.executeQuery();

while (rs.next()) {
  rs.getString("friends");
}
----

== Example: AnormCypher (Scala)

[source,scala]
----
Neo4jREST.setServer("localhost", 7474, "/db/data/", "username", "password")

// create
Cypher("""
   create ({name:"Peter"})-[:KNOWS]>({name:"Andres"})
"""
).execute()

// query
val req = Cypher("""
  MATCH user-[:KNOWS]-(friend) WHERE user.name = {name} RETURN friend.name as friends
""")

// result-stream
val stream = req().on("name" -> "Peter")

// extract (map) results into a string list
stream.map(row => {row[String]("friends")}).toList
----

== Example: NeoCons (Clojure)

[source,scala]
----
(ns neocons.docs.examples
  (:require [clojurewerkz.neocons.rest :as nr]
            [clojurewerkz.neocons.rest.cypher :as cy]))

(defn -main
  [& args]
  (nr/connect! "http://username:password@host:port/db/data/")
  (let [query "MATCH user-[:KNOWS]-(friend) WHERE user.name = {name}  
               RETURN friend.name as friends"
        res (cy/tquery query {:name "Peter"})]
    (println res)))
----

== A simplistic Java-Neo4j-Webapp 

[options=step]
* Uses Spark-Java
* Uses the JDBC Driver
* Uses jquery + d3
* https://github.com/jexp/neo4j-movies/tree/master/src/main/java/org/neo4j/example/movies[Let's have a look]

https://github.com/jexp/neo4j-movies[Repository]

// the end

[canvas-image="{img}/blank.png"]
== That's it

++++
<h1>Questions ? Thank You!</h1>
++++

== Next in Line

=== Spring Data Neo4j 3.0



[canvas-image="{img}/model4.png"]
== Drawing

[canvas-image="{img}/model5.png"]
== Drawing Overlay

[canvas-image="{img}/model6.png"]
== Graph

[canvas-image="{img}/model7.png"]
== Graph Enriched


== Graph Model

++++
<figure class="graph-diagram">
<ul class="graph-diagram-markup" data-internal-scale="1.58" data-external-scale="1">
  <li class="node" data-node-id="0" data-x="-115.53164556962025" data-y="-540.7594936708862">
    <span class="caption">Person</span><dl class="properties"><dt>name</dt><dd>Bob</dd><dt>age</dt><dd>38</dd></dl></li>
  <li class="node" data-node-id="1" data-x="-358.9403254972869" data-y="-330.334538878843">
    <span class="caption">Book</span><dl class="properties"><dt>title</dt><dd>"Graph Databases"</dd><dt>authors</dt><dd>"Ian Robinson, ..."</dd></dl></li>
  <li class="node" data-node-id="2" data-x="-565.6753022399126" data-y="-595.5646381619613">
    <span class="caption">Person</span><dl class="properties"><dt>name</dt><dd>Alice</dd><dt>age</dt><dd>34</dd></dl></li>
  <li class="relationship" data-from="0" data-to="1">
    <span class="type">Has Read</span><dl class="properties"><dt>date</dt><dd>Jun-03</dd><dt>rating</dt><dd>4</dd></dl></li>
  <li class="relationship" data-from="0" data-to="2">
    <span class="type">Friend Of</span>
  </li>
  <li class="relationship" data-from="2" data-to="1">
    <span class="type">Has Read</span><dl class="properties"><dt>date</dt><dd>Dec-05</dd><dt>rating</dt><dd>5</dd></dl></li>
  <li class="relationship" data-from="2" data-to="0">
    <span class="type">Friend Of</span>
  </li>
</ul></figure>
++++

== (Graphs)-[:HATE]->(Text-Files)

[options="step"]
* It's the 1000 words
* Single dimensional
* No graphics
* Verbose

== But Ascii-Art Rocks

[options="step"]
* Turn text into pictures
* The Power of Symbols
* Graph Patterns Made easy
* Hacker and Mudder Friendly
* Diffs, VCS

== But Ascii-Art Rocks

[role=small]
----

 _                         )      ((   ))     (
(@)                      /|\      ))_((     /|\                        _
|-|`\                   / | \    (/\|/\)   / | \                      (@)
| | -------------------/--|-voV---\`|'/--Vov-|--\---------------------|-|
|-|                         '^`   (o o)  '^`                          | |
| |                               `\Y/'                               |-|
|-|          Welcome to the Mages Lair Multiple User Dungeon          | |
| |                    Welcome to the Addiction.                      |-|
|-|                                                                   | |
| |                                                                   |-|
|_|___________________________________________________________________| |
(@)               l   /\ /        ( (       \ /\   l                `\|-|
                  l /   V          \ \       V   \ l                  (@)
                  l/               _) )_          \I
                                   `\ /'
                                     `
----

[canvas-image="{img}/blank.png"]
== Cypher

++++
<h1>Cypher</h1>
++++

== (Cypher)-[:USES]->(Ascii-Art)

[options="step"]
* Declarative Graph Query Language
* Graph Pattern Matching
* Humane, Readable
* Expressive
* Read and Write Graphs
* Tabular Results

[canvas-image="{img}/pattern2.gif"]
== Cypher Query

[canvas-image="{img}/pattern1.gif"]
== Cypher Pattern

== Cypher Query

=== Setup

[source,cypher]
----
CREATE (neo:Company {name:"Neo"})-[:IN]->(:Country {tld:"SE"})
CREATE (:Person {name:"Peter",age:40})-[:WORKS_AT]->(neo)
CREATE (:Person {name:"Kenny",age:23})-[:WORKS_AT]->(neo)
CREATE (:Person {name:"Kenny",age:23})-[:WORKS_AT]->(neo)
CREATE (structr:Company {name:"Structr"})-[:IN]->(:Country {tld:"DE"})
CREATE (:Person {name:"Axel",age:39})-[:WORKS_AT]->(structr)
CREATE (:Person {name:"Christian",age:25})-[:WORKS_AT]->(structr)
----

=== Query

[source,cypher]
----
// Count Hipsters by Country
MATCH (p:Person)-[:WORKS_AT]->(:Company)-[:IN]->(c:Country)
WHERE p.age < 28
RETURN c.tld, count(p) as hipsters
----

== How do you demo it?

* We built our own sandbox

=== The Neo4j Console
++++
<iframe src="http://console.neo4j.org/r/cctayc" width="800" height="400"></iframe>
++++

== Console - Sandbox, a useful Tool

=== How does it work?

[options="step"]
* Tiny Webapp on Heroku
* In-Memory throwaway Neo4j instances
* Simple Console UI with Graph Viz and Table Results
* One Click sharing
* Repl, SandBox, Bug-Reporter, Modeling Questions


=== People love it

[canvas-image="{img}/Neo4jConsole.jpg"]
== Neo4j Console Sample

[canvas-image="{img}/blank.png"]
== AsciiDoc

++++
<h1>AsciiDoc</h1>
++++

== AsciiDoc - the better Markup Language

[options="step"]
* Full Toolchain for book generation
* lots of options
* still easy to read text files
* generates html, pdf, text
* The Neo4j Manual is pure AsciiDoc goodness

== AsciiDoc Example (source)

[source,asciidoc]
----
== Basic AsciiDoc formatting

[width="50%",cols="1m,1a"]
|===
| \_Italic_ | _Italic_
| \*Bold* | *Bold*
| \`Monospace` | `Monospace`
| `http://www.neo4j.org/` | http://www.neo4j.org/
| `http://www.neo4j.org/[neo4j.org]` | http://www.neo4j.org/[neo4j.org]
| `link:./?5956246[Link to a GraphGist]` | link:./?5956246[Link to a GraphGist]
|===

Headings:

 = Heading 1
 == Heading 2
 === Heading 3

Images:

 image::http://assets.neo4j.org/img/still/cineasts.gif[]
----

[canvas-image="{img}/asciidoc_github.jpg"]
== AsciiDoc Example (rendered source)

[role="canvas-caption", position="bottom-right"] 
AsciiDoc Example (rendered source)

[canvas-image="{img}/asciidoc_gist.jpg"]
== AsciiDoc Example (rendered)

[role="canvas-caption", position="bottom-right"] 
AsciiDoc Example (rendered)

== AsciiDoctor - the better AsciiDoc

[options="step"]
* Reimplementation in Ruby (also jRuby)
* **Much** faster
* lots of extensions
* support for deck.js (you see it)
* Cross-Compiled to Javascript (Opal.js)

== Focus, Michael

=== What was the question again?

=== How to present a live, graph model?

== What is a gist?

* A useful snippet of information
* Easy to share, fork and change
* Nicely rendered and presented

== What is a GraphGist?

=== an AsciiDoc file with:

[options="step"]
* a graph domain model (cypher)
* describing text and pictures
* some example queries checked against the model
* interactively executable (Cypher)
* a Neo4j Console for further exploration


[canvas-image="{img}/got_gist.jpg"]
== Really? The GraphGist idea
[role="canvas-caption", position="bottom-right"] 
http://gist.neo4j.org/?6029850[]

== What does it look like?

[source,role=small]
----
 = The Game of Thrones in Neo4j
 
 image::http://maxdemarzidotcom.files.wordpress.com/2013/06/neoiscoming.jpg?w=580[]
 
 == The setup
 
 //hide
 [source,cypher]
 ----
 CREATE 
 (_0 { name:"Westeros" }),
 (_1 { house:"Tully" }),
 ...
 (_13 { name:"Danaerys" }),
 ...
 (_28 { name:"Tyrion" }), 
 _1-[:HOUSE]->_0, 
 _13-[:MARRIED_TO]->_12, 
 _14-[:CHILD_OF]->_8, 
 ...
 _27-[:CHILD_OF]->_19, _28-[:CHILD_OF]->_10
 ----
 
 //graph

 == Find all children of all houses

 [source, cypher]
 ----
 MATCH (westeros)<-[:HOUSE]-(house)<-[:OF_HOUSE]-(ancestor), family=(ancestor)<-[:CHILD_OF*0..]-(last)
 WHERE westeros.name='Westeros'
 RETURN house.house, collect(DISTINCT last.name)
 ----

 //table

 == Find all the children of parents that are siblings 

 [source,cypher]
 ----
 MATCH (kid)-[:CHILD_OF]->(parent1)-[:CHILD_OF]->(ancestor)<-[:CHILD_OF]-(parent2)<-[:CHILD_OF]-(kid) 
 RETURN DISTINCT kid.name as name
 ----
 
 //table
----


== What does it look like? (setup)

[source]
----
 = The Game of Thrones in Neo4j
 
 image::http://maxdemarzidotcom.files.wordpress.com/2013/06/neoiscoming.jpg?w=580[]
 
 == The setup
 
 //hide
 [source,cypher]
 ----
 CREATE 
 (_0 { name:"Westeros" }),
 (_1 { house:"Tully" }),
 ...
 (_13 { name:"Danaerys" }),
 ...
 (_28 { name:"Tyrion" }), 
 _1-[:HOUSE]->_0, 
 _13-[:MARRIED_TO]->_12, 
 _14-[:CHILD_OF]->_8, 
 ...
 _27-[:CHILD_OF]->_19, _28-[:CHILD_OF]->_10
 ----
 
 //graph

----

== What does it look like? (use-case)

[source]
----
  == Find all children of all houses
  
  [source, cypher]
  ----
  MATCH (westeros)<-[:HOUSE]-(house)<-[:OF_HOUSE]-(ancestor), family=(ancestor)<-[:CHILD_OF*0..]-(last)
  WHERE westeros.name='Westeros'
  RETURN house.house, collect(DISTINCT last.name)
  ----
  
  //table
  
  //graph

----

[canvas-image="{img}/graphgist.jpg"]
== Graph Gist Graph

[canvas-image="{img}/blank.png"]
== Power Tool Combo

++++
<h1>Power Tool Combo</h1>
++++

== Power Combination of Cool Tools

[options="step"]
* AsciiDoc(tor) running in Browser with Opal.js
* Cypher
* Neo4j Console
* JavaScript (D3.js, jQuery)
* HTML5 (postMessage)
* GitHub Gists

=== The Glue? Javascript

[canvas-image="{img}/swiss-army-knife.jpg"]
== Swiss Army Knife

== How does it work (Rendering)?

[options="step"]
. Load Gist file from GitHub Gist / Url
. Render AsciiDoc to HTML5 on the fly
. Write to page / CSS
. Placeholder replacement

== How does it work (Queries) ?

[options="step",start=5]
. Instantiate Console IFrame
. Find all setup- and use-case queries
. Send to Console, Check Results
. Render Results as Table or Graph
. Reset and Show Console


== Next Step ?

=== We have a great tool for model documentation

=== Now we need some models, aka content

=== Don't make something up!

=== Ask your users, your Community

=== Create a Challenge (or two)


== First Challenge (September)

[options="step"]
* Give me anything
* Nice Prizes (Money, Books, T-Shirts, Tickets)
* Impressive http://blog.neo4j.org/2013/10/the-first-graphgist-challenge-completed.html[17 submissions in 4 weeks]

=== Winners

[options="step"]
. http://gist.neo4j.org/?6619085[US Flights & Airports] by Nicole White
. http://gist.neo4j.org/?github-jotomo%2Fneo4j-gist-challenge%2F%2Flearning-graph%2Flearning-graph.adoc[Learning Graph] by Johannes Mockenhaupt
. http://gist.neo4j.org/?6506717[Chess Games] and Positions by Wes Freeman

== Second Challenge (Winter Dec+Jan)

[options="step"]
* 10 Categories from Education, Tranport up to Advanced aka. "Show Off"
* Unbelievable https://github.com/neo4j-contrib/graphgist/wiki[65 submissions in 8 weeks w/ holidays]
* High quality content
* Hard to choose winners

== Winter Challenge Winners

[options="step"]
* http://blog.neo4j.org/2014/02/graph-gist-winter-challenge-winners.html[11 Winners in the categories], just 3 examples
* http://gist.neo4j.org/?8021754[Organization Learning] by @luannem - covering your path through courses and certifications in a learning management system.
* http://gist.neo4j.org/?8139605[Single Malt Scotch Whisky] by @patbaumgartner is my personal favorite, you certainly know why
* http://gist.neo4j.org/?8526106[Amazon Web Services Global Infrastructure Graph] by @aidanjcasey represents all regions, zones, services and instance types as a graph

== What's in for you?

[options="step"]
* Use them !
* GraphGists are fun
* They help you model, communicate and discuss your domain
* Great for Stackoverflow questions and answers
* Free to use, any AsciiDoc-File-URL will do
* Rendered in your Browser

== Can I win something?

[options="step"]
* Sure
* Submit your original GraphGist through this form http://bit.ly/graphgist
* Get A T-Shirt
* Be famous

[canvas-image="{img}/blank.png"]
== That's it

++++
<h1>Questions ? Thank You!</h1>
++++
